<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Training Protocol | 8-Day System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --bg: #0f172a;
            --card: #1e293b;
            --accent: #38bdf8;
            --text: #f8fafc;
            --muted: #94a3b8;
            --success: #22c55e;
            --gold: #fbbf24;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: var(--bg); color: var(--text); line-height: 1.6; padding-bottom: 80px; }

        /* Smooth UI Elements */
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; padding: 40px 0; animation: fadeIn 1s ease; }
        .header h1 { font-size: 2rem; color: var(--accent); letter-spacing: -1px; }

        .unit-card { 
            background: var(--card); border-radius: 20px; padding: 20px; 
            margin-bottom: 20px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.05);
            transition: transform 0.3s ease;
        }

        .exercise-item {
            background: rgba(255,255,255,0.03); border-radius: 12px;
            padding: 15px; margin-bottom: 15px; border-right: 4px solid var(--accent);
        }

        .input-group { display: flex; gap: 10px; margin-top: 10px; }
        input { 
            background: #0f172a; border: 1px solid #334155; color: white;
            padding: 10px; border-radius: 8px; width: 100%; text-align: center;
        }

        .btn {
            background: var(--accent); color: var(--bg); border: none;
            padding: 12px 20px; border-radius: 10px; font-weight: bold;
            cursor: pointer; width: 100%; margin-top: 10px; transition: 0.3s;
        }

        .ai-feedback {
            background: rgba(56, 189, 248, 0.1); color: var(--accent);
            padding: 10px; border-radius: 8px; font-size: 0.85rem; margin-top: 10px;
            border-left: 3px solid var(--accent); display: none;
        }

        /* Navigation Bar */
        .nav-bar {
            position: fixed; bottom: 0; width: 100%; background: var(--card);
            display: flex; justify-content: space-around; padding: 15px;
            border-top: 1px solid #334155; z-index: 1000;
        }
        .nav-item { color: var(--muted); cursor: pointer; font-size: 0.9rem; }
        .nav-item.active { color: var(--accent); font-weight: bold; }

        /* Meta Analysis Styles */
        #analysis-page, #history-page { display: none; }
        .chart-container { background: var(--card); padding: 15px; border-radius: 20px; margin-top: 20px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .pr-badge { background: var(--gold); color: black; padding: 2px 8px; border-radius: 5px; font-size: 0.7rem; font-weight: bold; margin-right: 5px; display: none;}
    </style>
</head>
<body>

<div class="container" id="main-content">
    <div id="workout-page">
        <div class="header">
            <h1 id="current-unit-title">UNIT-01: PUSH 1</h1>
            <p id="unit-subtitle" style="color: var(--muted);">Ø§Ø¨Ø¯Ø£ Ø¬Ù„Ø³Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„ÙŠÙˆÙ…</p>
        </div>
        <div id="exercise-list">
            </div>
        <button class="btn" onclick="completeWorkout()" style="background: var(--success);">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªÙ…Ø±ÙŠÙ† ÙˆØ­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    </div>

    <div id="analysis-page">
        <div class="header"><h1>Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ (Meta Analysis)</h1></div>
        <div class="chart-container">
            <canvas id="volumeChart"></canvas>
        </div>
        <div class="chart-container" style="margin-top: 20px;">
            <canvas id="prChart"></canvas>
        </div>
        <div id="ai-insights" class="unit-card" style="margin-top: 20px; border-right: 4px solid var(--gold);">
            <h3>ØªÙˆØµÙŠØ§Øª Ø§Ù„Ù€ AI Ø§Ù„Ø¹Ø§Ù…Ø©:</h3>
            <p id="general-advice" style="font-size: 0.9rem; margin-top:10px;">Ù‚Ù… Ø¨Ø¥Ù†Ù‡Ø§Ø¡ Ø£ÙˆÙ„ ØªÙ…Ø±ÙŠÙ† Ù„ØªØ­Ù„ÙŠÙ„ Ù…Ø³ØªÙˆØ§Ùƒ...</p>
        </div>
    </div>

    <div id="history-page">
        <div class="header"><h1>Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ (Archives)</h1></div>
        <div id="history-list"></div>
    </div>
</div>

<nav class="nav-bar">
    <div class="nav-item active" onclick="showPage('workout')">Ø§Ù„ØªÙ…Ø±ÙŠÙ†</div>
    <div class="nav-item" onclick="showPage('analysis')">Ø§Ù„ØªØ­Ù„ÙŠÙ„</div>
    <div class="nav-item" onclick="showPage('history')">Ø§Ù„Ø³Ø¬Ù„</div>
</nav>

<script>
    // --- Data Structure & Protocol ---
    const protocol = [
        { id: 1, title: "UNIT-01: PUSH 1", exercises: ["Triceps Overhead", "Shoulder Press", "Chest Incline", "Chest Flat", "Lateral Raises", "Incline Flyes", "Triceps Pushdown"], sets: [2,2,3,2,2,2,2] },
        { id: 2, title: "UNIT-02: PULL 1", exercises: ["T-Bar Row", "Lat Pulldown", "Bicep Preacher", "Seated Row", "Seated Row 2", "Bicep Incline", "Rear Delt Flye", "Shrugs"], sets: [2,3,2,2,2,2,2,2] },
        { id: 3, title: "UNIT-03: LEGS & FORE", exercises: ["Calf Raise", "Leg Press", "Leg Extension", "Lying Leg Curl", "Hip Adduction", "Reverse Grip Curl", "Wrist Curl", "Wrist"], sets: [2,2,3,2,2,2,2,2] },
        { id: 4, title: "UNIT-04: ARMS & WEAK", exercises: ["Lateral Raises", "Shoulder Press", "Rear Delt Flye", "Hammer Curl", "Triceps Overhead", "Bicep Incline", "Triceps Pushdown", "Bicep Preacher", "Single-Arm Pushdown"], sets: [3,2,2,2,2,2,2,2,2] },
        { id: 5, title: "UNIT-05: REST", exercises: ["SYSTEM_REBOOT - Ø§Ø³ØªØ±Ø§Ø­Ø© ØªØ§Ù…Ø©"], sets: [0] },
        { id: 6, title: "UNIT-06: PUSH 2", exercises: ["Triceps Overhead", "Shoulder Press", "Chest Flat", "Chest Incline", "Lateral Raises", "Incline Flyes", "Triceps Pushdown"], sets: [2,1,2,3,3,2,2] },
        { id: 7, title: "UNIT-07: PULL 2", exercises: ["T-Bar Row", "Lat Pulldown", "Preacher", "Seated Row", "Seated Row 2", "Biceps Incline", "Reverse Flyes", "Shrugs"], sets: [2,2,2,3,2,2,2,2] },
        { id: 8, title: "UNIT-08: RESET", exercises: ["Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…"], sets: [0] }
    ];

    let db = JSON.parse(localStorage.getItem('workoutDB')) || { logs: [], currentUnitIndex: 0 };

    // --- Core Functions ---
    function init() {
        renderWorkout();
        setupCharts();
    }

    function renderWorkout() {
        const unit = protocol[db.currentUnitIndex];
        document.getElementById('current-unit-title').innerText = unit.title;
        const list = document.getElementById('exercise-list');
        list.innerHTML = '';

        if (unit.sets[0] === 0) {
            list.innerHTML = `<div class="unit-card" style="text-align:center;"><h2>Ø§Ù„ÙŠÙˆÙ… ÙŠÙˆÙ… Ø±Ø§Ø­Ø© ğŸ›Œ</h2><p>Ø¹Ø¶Ù„Ø§ØªÙƒ ØªÙ†Ù…Ùˆ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†ÙˆÙ…ØŒ ÙˆÙ„ÙŠØ³ ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ø¬ÙŠÙ….</p></div>`;
            return;
        }

        unit.exercises.forEach((ex, idx) => {
            const lastData = getLastPerformance(ex);
            const div = document.createElement('div');
            div.className = 'exercise-item';
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between;">
                    <strong>${ex}</strong>
                    <span style="font-size:0.8rem; color:var(--muted)">Ø§Ù„Ø³Ø§Ø¨Ù‚: ${lastData.weight}kg Ã— ${lastData.reps}</span>
                </div>
                <div class="input-group">
                    <input type="number" id="w-${idx}" placeholder="Ø§Ù„ÙˆØ²Ù† (kg)" value="${lastData.weight}">
                    <input type="number" id="r-${idx}" placeholder="Ø§Ù„Ø¹Ø¯Ø§Øª" value="${lastData.reps}">
                </div>
                <div class="ai-feedback" id="ai-${idx}">${generateAIAdvice(ex, lastData)}</div>
            `;
            list.appendChild(div);
            // Show AI advice if data exists
            if(lastData.weight > 0) document.getElementById(`ai-${idx}`).style.display = 'block';
        });
    }

    function getLastPerformance(exerciseName) {
        const history = db.logs.filter(l => l.exercise === exerciseName);
        if (history.length === 0) return { weight: 0, reps: 0 };
        return history[history.length - 1];
    }

    function generateAIAdvice(ex, last) {
        if (last.weight === 0) return "Ù‡Ø°Ù‡ Ø£ÙˆÙ„ Ù…Ø±Ø© ØªÙ„Ø¹Ø¨ ÙÙŠÙ‡Ø§ Ù‡Ø°Ø§ Ø§Ù„ØªÙ…Ø±ÙŠÙ†. Ø±ÙƒØ² Ø¹Ù„Ù‰ Ø§Ù„ØªÙƒÙ†ÙŠÙƒ.";
        // Simple AI Logic for Progressive Overload
        if (last.reps >= 12) return `ğŸ’¡ Ø§Ù„Ù€ AI ÙŠÙ†ØµØ­: ÙˆØ²Ù† Ø§Ù„Ù€ ${last.weight} Ø£ØµØ¨Ø­ Ø³Ù‡Ù„Ø§Ù‹. Ø²Ø¯ Ø§Ù„ÙˆØ²Ù† 2.5kg Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©.`;
        if (last.reps < 6) return `ğŸ’¡ Ø§Ù„Ù€ AI ÙŠÙ†ØµØ­: Ø§Ù„ÙˆØ²Ù† Ø«Ù‚ÙŠÙ„ Ø¬Ø¯Ø§Ù‹. Ø±ÙƒØ² Ø¹Ù„Ù‰ Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ø¯Ø§Øª Ø­ØªÙ‰ ØªØµÙ„ Ù„Ù€ 8-10 Ù‚Ø¨Ù„ Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙˆØ²Ù†.`;
        return `ğŸ’¡ Ø§Ù„Ù€ AI ÙŠÙ†ØµØ­: Ø­Ø§ÙˆÙ„ ÙƒØ³Ø± Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¯Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚ (${last.reps}) Ø¨Ù†ÙØ³ Ø§Ù„ÙˆØ²Ù†.`;
    }

    function completeWorkout() {
        const unit = protocol[db.currentUnitIndex];
        const date = new Date().toISOString();
        let sessionVolume = 0;
        let prBroken = false;

        unit.exercises.forEach((ex, idx) => {
            const w = parseFloat(document.getElementById(`w-${idx}`).value) || 0;
            const r = parseInt(document.getElementById(`r-${idx}`).value) || 0;
            
            if (w > 0) {
                const prev = getLastPerformance(ex);
                if (w > prev.weight || (w == prev.weight && r > prev.reps)) {
                    prBroken = true;
                }
                
                db.logs.push({
                    date: date,
                    unit: unit.title,
                    exercise: ex,
                    weight: w,
                    reps: r,
                    volume: w * r * unit.sets[idx]
                });
                sessionVolume += w * r * unit.sets[idx];
            }
        });

        if (prBroken) {
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            alert("ğŸ”¥ Ø£Ø¯Ø§Ø¡ Ø¬Ø¨Ø§Ø±! Ù„Ù‚Ø¯ ÙƒØ³Ø± Ø£Ø±Ù‚Ø§Ù…Ø§Ù‹ Ù‚ÙŠØ§Ø³ÙŠØ© Ø§Ù„ÙŠÙˆÙ…!");
        }

        // Move to next unit
        db.currentUnitIndex = (db.currentUnitIndex + 1) % protocol.length;
        saveData();
        alert(`ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ…Ø±ÙŠÙ†. Ø§Ù„ÙÙˆÙ„ÙŠÙˆÙ… Ø§Ù„ÙƒÙ„ÙŠ: ${sessionVolume}kg`);
        location.reload();
    }

    function saveData() {
        localStorage.setItem('workoutDB', JSON.stringify(db));
    }

    // --- Navigation ---
    function showPage(page) {
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.getElementById('workout-page').style.display = 'none';
        document.getElementById('analysis-page').style.display = 'none';
        document.getElementById('history-page').style.display = 'none';

        if(page === 'workout') {
            document.getElementById('workout-page').style.display = 'block';
            event.currentTarget.classList.add('active');
        } else if(page === 'analysis') {
            document.getElementById('analysis-page').style.display = 'block';
            renderAnalysis();
        } else {
            document.getElementById('history-page').style.display = 'block';
            renderHistory();
        }
    }

    // --- Charts & Meta Analysis ---
    function renderAnalysis() {
        const ctx = document.getElementById('volumeChart').getContext('2d');
        const dates = [...new Set(db.logs.map(l => l.date.split('T')[0]))].slice(-10);
        const volumes = dates.map(d => {
            return db.logs.filter(l => l.date.startsWith(d)).reduce((sum, curr) => sum + curr.volume, 0);
        });

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [{
                    label: 'Total Volume (kg)',
                    data: volumes,
                    borderColor: '#38bdf8',
                    tension: 0.4,
                    fill: true,
                    backgroundColor: 'rgba(56, 189, 248, 0.1)'
                }]
            },
            options: { responsive: true, plugins: { legend: { display: false } } }
        });

        // AI General Insight
        const totalSessions = dates.length;
        if(totalSessions > 3) {
            const trend = volumes[volumes.length-1] > volumes[0] ? "ØªØµØ§Ø¹Ø¯ÙŠ Ù…Ù…ØªØ§Ø²" : "Ù…Ø³ØªÙ‚Ø±";
            document.getElementById('general-advice').innerText = `ØªØ­Ù„ÙŠÙ„ÙŠ Ù„Ø¢Ø®Ø± ${totalSessions} Ø¬Ù„Ø³Ø§Øª ÙŠØ¸Ù‡Ø± ØªØ·ÙˆØ± ${trend}. Ù…Ø¹Ø¯Ù„ Ø§Ø³ØªÙ‡Ù„Ø§ÙƒÙƒ Ù„Ù„Ø£ÙˆØ²Ø§Ù† Ø°ÙƒÙŠ Ø¬Ø¯Ø§Ù‹ØŒ Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ø§Ù„Ù€ 8 Ø£ÙŠØ§Ù….`;
        }
    }

    function renderHistory() {
        const list = document.getElementById('history-list');
        list.innerHTML = '';
        const sortedLogs = [...db.logs].reverse();
        
        let currentMonth = "";
        sortedLogs.forEach(log => {
            const dateObj = new Date(log.date);
            const monthYear = dateObj.toLocaleDateString('ar-EG', { month: 'long', year: 'numeric' });
            
            if(monthYear !== currentMonth) {
                currentMonth = monthYear;
                list.innerHTML += `<h3 style="margin:20px 0 10px; color:var(--accent)">${monthYear}</h3>`;
            }

            list.innerHTML += `
                <div class="exercise-item" style="border-right-color: var(--muted); opacity: 0.8;">
                    <div style="display:flex; justify-content:space-between;">
                        <span>${log.exercise}</span>
                        <span>${log.weight}kg Ã— ${log.reps}</span>
                    </div>
                    <small style="color:var(--muted)">${dateObj.toLocaleDateString('ar-EG')}</small>
                </div>
            `;
        });
    }

    // Service Worker Registration for Offline Use
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js').catch(err => console.log('SW registration failed:', err));
        });
    }

    init();
</script>

<script id="sw-code" type="text/plain">
    const cacheName = 'gym-ai-v1';
    self.addEventListener('install', e => {
        e.waitUntil(caches.open(cacheName).then(cache => cache.addAll(['/', '/index.html'])));
    });
    self.addEventListener('fetch', e => {
        e.respondWith(caches.match(e.request).then(res => res || fetch(e.request)));
    });
</script>

</body>
</html>
